### 14.2.5. InnoDB特性：灵活性、易用性和可靠性
本节描述了InnoDB几个新增的特性，这些特性为InnoDB增加了新的灵活性，提高了易用性、可靠性和性能。Barracuda文件格式不但提高了大型可变长度列的存储效率，还可以将表压缩存储。以前，这项配置不能在启动后修改，而现在可以灵活地动态修改。其中一些改进是自动的，比如更快、更有效地
```TRUNCATE TABLE```（截断表）。另外一些改进可以使你更灵活地管控InnoDB的行为；例如，你可以更好地把握某些问题是否会导致错误或者只是警告，并且信息消息和错误报告会更人性化。

#### 14.2.5.1. 支持只读介质
在服务器启动选项启用```--innodb-read-only [1779]```，你就可以查询MySQL数据目录是只读介质上的InnoDB表。
### 如何启用
如果要将一个实例转成只读操作，首先要确保在存储到只读介质上之前，所有必要的信息已经刷新到数据文件。在禁用change buffer的模式下启动服务器(```innodb_change_buffering=0 [1746]```)，使用```slow shutdown```方式关闭服务器。

要使整个MySQL实例处于只读模式，指定以下启动选项：**

* --innodb-read-only=1 [1779]
* 如果实例是DVD或CD等只读介质，或/var目录不是可写的，则需要指定:```--pid-file=path_on_writeable_media``` 和 ```--event-scheduler=disabled```

### 使用场景
这种方式的操作适用于以下情况:

* 在DVD、CD等只读存储介质上部署MySQL应用程序或MySQL数据。
* 多个MySQL实例查询相同的数据目录同时，通常出现在数据仓库的配置中。当一个MySQL实例负载很高，或者需要针对不同实例使用不同配置选项来优化特定的查询的时候，你可以使用这种技术来避免瓶颈。
* 有时为了安全或数据完整性，数据会被设定成只读状态，如存档备份数据。

	> ### **注意**
	> 此功能主要用于分发和部署的灵活性，而不是仅仅考虑到性能。查看14.2.4.2.3章节，“只读事务优化”的方法来优化只读查询的性能，而不需要让整个服务器只读。

### 它是如何工作的
当服务器通过```--innodb-read-only [1779]```选项运行在只读模式，某些InnoDB特性和组件将减少或完全关闭:

* ```change buffering```（修改缓冲）将不工作，特别是不会有change buffer合并操作。当你为只读实例做准备工作的时候，要确保change buffer是空的，先禁用```change buffer(innodb_change_buffering=0 [1746])```，然后做一次```slow shutdown```。
* 启动过程没有crash recovery（崩溃恢复）。实例被设定成只读状态之前，必须先做一次```slow shutdown```
* 因为只读操作不需要```redo log```（重做日志），你可以将```innodb_log_file_size [1769]```设置成最小值(1 MB)，然后将实例设置成只读。
* 除了I/O读取线程，所有后台线程是关闭的。因此,一个只读的实例不可能发生死锁。
* 死锁信息、监视器输出等等不会写入临时文件。因此，```SHOW ENGINE INNODB STATUS```不会产生任何输出。
* 如果MySQL服务器使用```--innodb-read-only [1779]```选项启动，但数据目录仍在可写介质，root用户仍然可以执行DCL操作,如GRANT和REVOKE。
* 更改那些通常会改变写操作行为的配置选项，对运行在只读模式的服务器没有影响。
* MVCC强制关闭隔离级别。所有查询读到的是最新版本，因为更新和删除是不可能的。
* 无需用到undo log。禁用```innodb_undo_tablespaces [1788]```及```innodb_undo_directory [1787]```配置选项。

#### 14.2.5.2. 更大的Redo Log文件大小限制
以前，InnoDB Redo Log文件的总大小限制是4GB。从MySQL5.6.3开始，这个大小限制提高到512GB。

你不需要任何特殊的升级过程或文件格式就可以使用此功能。记录额外尺寸信息的字节已经保留，并在InnoDB系统表空间中设置为零。

如果你开发与InnoDB逻辑序列号(LSN)交互的应用程序，请修改你的代码，使用有保障的64位变量来存储和比较LSN，不要使用32位变量。

#### 14.2.5.3. InnoDB表的2-Byte排序规则id
InnoDB表可以使用大于255的排序规则id。目前，这个范围内的排序规则id都是用户定义的。例如，现在可以创建以下InnoDB表，然而在以前，排序规则id 359是已经超出了InnoDB支持的范围。
	
	sql> show collation like 'ucs2_vn_ci';
	+------------+---------+-----+---------+----------+---------+
	| Collation | Charset | Id | Default | Compiled | Sortlen |
	+------------+---------+-----+---------+----------+---------+
	| ucs2_vn_ci | ucs2 | 359 | | | 8 |
	+------------+---------+-----+---------+----------+---------+
	1 row in set (0.00 sec)
	mysql> create table two_byte_collation (c1 char(1) character set ucs2 collate ucs2_vn_ci)
	-> engine = InnoDB;
	Query OK, 0 rows affected (0.16 sec)
	
#### 14.2.5.4. Barracuda文件格式
InnoDB已经开始使用命名的文件格式来提高升级、降级和在异构系统运行不同级别的MySQL时的兼容性。许多InnoDB的重要特性，例如表压缩和BLOB更有效的动态行格式存储，就需要使用Barracuda文件格式创建表。原来的文件格式，以前没有名字，现在被称为Antelope。

使用配置参数```innodb_file_format [1752]```启用Barracuda文件格式，这样在创建新表的时候，就会使用Barracuda文件格式。这个参数同时也决定了新创建的表或索引是否可以使用压缩或动态行格式。

在内置InnoDB的MySQL 5.1以及之前版本中，需要禁用Barracuda文件格式的特性，可以忽略```innodb_file_format [1752]```的设置或设置成Antelope格式。

你可以在命令行启动mysqld时设置值```innodb_file_format [1752]```，或在选项文件my.cnf(Unix操作系统)或my.ini(Windows)中设置。你也可以使用```SET GLOBAL```语句动态修改设置。

更多关于管理文件格式的信息，请参阅5.4.7章节, “```InnoDB File-Format Management```”。

#### 14.2.5.5. 动态修改系统配置参数
MySQL 5.5和更高版本中，修改某些系统配置参数，不需要关闭或重启服务器，然而在MySQL 5.1和更低版本中，这是必需的。这增加正常运行时间，









让它更容易测试和规范新的SQL和应用程序代码。









下面的章节将详细讲解这些参数。

##### 14.2.5.5.1. 动态修改```innodb_file_per_table```
从MySQL 4.1版本开始，InnoDB表在磁盘上有两种存储方式，一种方式是在共享的系统表空间上创建表及其索引，这种方式表将会物理存储在ibdata文件中。另外一种方式是在独立表空间(.ibd文件)上创建表及其索引。每个InnoDB表的存储位置是由建表时的配置参数```innodb_file_per_table [1754]```决定的。

在MySQL 5.5和更高版本中，配置参数```innodb_file_per_table [1754]```是动态的，可以使用SET GLOBAL命令打开或关闭。而以前的版本中，唯一的办法是在MySQL配置文件(my.cnf或my.ini)中设置这个参数，修改它需要关闭和重启服务器。

默认设置是关闭的，所以新表和索引在系统表空间中创建。动态修改该参数需要SUPER权限，修改后所有连接会立即生效。

当建表的时候```innodb_file_per_table [1754]```是启用的，这时可以使用Barracuda文件格式，TRUNCATE操作会将表的磁盘空间返还给操作系统。Barracuda文件格式支持表压缩和动态行格式等特性。当建表的时候```innodb_file_per_table [1754]```是禁用的，这些特性将不可用。如果现有的表想利用这些特性，你可以打开file-per-table设置并在这些表上运行```ALTER TABLE t ENGINE=INNODB```操作。

当重新定义InnoDB表的主键的时候，会使用当前的```innodb_file_per_table [1754]```和```innodb_file_format [1752]```设置来重建表。就像在```InnoDB存储引擎的快速创建索引```中描述的一样，增加或删除InnoDB二级索引不会对此有影响。如果创建二级索引的时候没有重建表，索引会存储在与表数据相同的文件中，而与当前的```innodb_file_per_table [1754]```设置无关。

##### 14.2.5.5.2. 动态修改```innodb_stats_on_metadata```
在MySQL 5.5和更高版本中，可以在运行时动态修改```innodb_stats_on_metadata [1782]```的设置，用来控制是否在InnoDB元数据语句被执行的时候收集统计信息。可能使用以下语句来修改设置，```SET GLOBAL innodb_stats_on_metadata=mode```，mode可以是ON或OFF(1或0)。修改此设置需要SUPER权限，修改后会立即影响所有连接。

与此设置相关的章节是14.2.5.8，“控制优化器统计评估方式”。

##### 14.2.5.5.3. 动态修改```innodb_lock_wait_timeout```
一个事务在放弃和回滚一个语句之前等待资源的时间，是由配置参数```innodb_lock_wait_timeout [1765]```决定的。(在MySQL 5.0.12和更早版本中，整个事务会被回滚，不只是当前语句。)应用程序可以重试当前语句(通常在等待一段时间之后)，或回滚整个事务之后再重启。

错误时返回超时周期超过:

	ERROR HY000: Lock wait timeout exceeded; try restarting transaction

在MySQL 5.5和更高版本中，配置参数```innodb_lock_wait_timeout [1765]```可以在运行时使用SET GLOBAL或SET SESSION设置。更改全局设置需要SUPER权限并且会影响随后连接所有客户端。任何客户端也可以修改```innodb_lock_wait_timeout [1765]```的SESSION设置，这只会影响当前客户端。

在MySQL 5.1和更早版本中，唯一的办法是在MySQL配置文件(my.cnf或my.ini)设置这个参数，并且修改它需要关闭和重启服务器。

##### 14.2.5.5.4. 动态修改```innodb_adaptive_hash_index```
就像14.2.4.2.14章节--”控制自适应哈希索引”中描述的，在有些情况下是有用的，可以根据负载情况，动态地启用或禁用InnoDB的自适应哈希索引来提高查询性能。

你可以使用配置选项```innodb_adaptive_hash_index [1738]```禁用自适应哈希索引。默认是启用的。你可以使用SET GLOBAL语句修改这个参数而不需要重启服务器。修改此设置需要SUPER权限。

禁用自适应哈希索引会立即清空哈希表。哈希表为空时，普通操作都可以继续，使用哈希表访问索引的查询会被B-trees代替。当再次启用自适应哈希索引时，哈希表会在普通操作时再次填充。

#### 14.2.5.6. TRUNCATE TABLE 回收空间
当截断一个存储在独立.ibd文件中的表时(创建表时启用了```innodb_file_per_table [1754]```)，并且此表没有外键约束，此表将被删除并在一个新的.ibd文件中重建。这样操作的速度比一行行删除要快得多。操作系统可以重用该磁盘空间，如果使用InnoDB系统表空间，则不能重用。只有InnoDB可以在截断后重用磁盘空间。物理备份也可以缩小，没有大的块未使用的空间在系统的中间表空间。
MySQL 5.1和更早的版本中，可以重用已存在的.ibd文件，但这样释放出空间到InnoDB，而没有到操作系统。需要注意的是，当截断表时，受TRUNCATE TABLE语句影响的行数只是个随机数。

> ### 注意 ###
> 如果在同一个表的两列之间有一个外键约束，仍然可以使用截断表这样的快速技术。
> 
> 如果在被截断的表和其他表之间有外键约束，截断操作将会失败。与之前的行为不同的是，将会把截断操作转换为删除所有行的操作，并且将触发子表的ON DELETE操作。

#### 14.2.5.7. InnoDB Strict Mode

#### 14.2.5.8. Controlling Optimizer Statistics Estimation

#### 14.2.5.9. Better Error Handling when Dropping Indexes

#### 14.2.5.10. More Compact Output of SHOW ENGINE INNODB MUTEX

#### 14.2.5.11. More Read-Ahead Statistics
