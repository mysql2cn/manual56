### 14.2.5. InnoDB特性：灵活性、易用性和可靠性
本节描述了InnoDB几个新增的特性，这些特性为InnoDB增加了新的灵活性，提高了易用性、可靠性和性能。Barracuda文件格式不但提高了大型可变长度列的存储效率，还可以将表压缩存储。在以前版本中，这项配置不能在启动后修改，而现在可以灵活地动态修改。一些改进是自然而然的，比如更快、更有效地截断表(
```TRUNCATE TABLE```)。另外一些改进可以使你更灵活地管控InnoDB的行为；例如，你可以更好地把握某些问题是否会导致错误或者只是警告，并且信息消息和错误报告会更人性化。

#### 14.2.5.1. 支持只读介质
在服务器启动选项中启用```--innodb-read-only``` [1779]，你就可以查询MySQL数据目录是只读介质上的InnoDB表。
##### 如何启用
如果要将一个实例转成只读操作，首先要确保在存储到只读介质上之前，所有必要的信息已经刷新(```flushed```)到数据文件。在禁用修改缓冲区的模式下启动服务器(```innodb_change_buffering=0``` [1746])，使用```slow shutdown```方式关闭服务器。

要使整个MySQL实例处于只读模式，指定以下启动选项：

* ```--innodb-read-only=1``` [1779]
* 如果实例在DVD或CD等只读介质上，或者/var目录是不可写的，则需要指定:```--pid-file=path_on_writeable_media``` 和 ```--event-scheduler=disabled```

##### 使用场景
这种操作方式适用于以下场景:

* 在DVD、CD等只读存储介质上部署MySQL应用程序或MySQL数据。
* 多个MySQL实例同时查询相同的数据目录，通常出现在数据仓库的配置中。当一个MySQL实例负载很高，或者需要针对不同实例使用不同配置选项来优化特定的查询的时候，你可以使用这种技术来避免瓶颈(bottlenecks)。
* 有时为了安全或数据完整性，数据会被设定成只读状态，如存档备份数据。

	> ### **注意**
	> 此功能主要用于分发和部署的灵活性，而不是仅仅考虑到性能。查看14.2.4.2.3章节，“只读事务的优化”，讲述了无需让整个服务器只读而优化只读查询性能的方法。

##### 它是如何工作的
当服务器通过```--innodb-read-only``` [1779]选项运行在只读模式，某些InnoDB特性和组件将缩减或完全关闭:

* 修改缓冲区（```change buffering```）将不工作，特别是不会有修改缓冲区合并操作。当你为只读实例做准备工作的时候，要确保修改缓冲区是空的，先禁用修改缓冲区(```innodb_change_buffering=0``` [1746])，然后做一次```slow shutdown```。
* 启动过程没有崩溃恢复（```crash recovery```）。实例被设定成只读状态之前，必须先做一次```slow shutdown```
* 因为只读操作不需要重做日志（```redo log```），你可以将```innodb_log_file_size``` [1769]设置成最小值(1 MB)，然后将实例设置成只读。
* 除了I/O读取线程，所有后台线程是关闭的。因此，一个只读的实例不可能发生死锁。
* 死锁信息、监视器输出等等不会写入临时文件。因此，```SHOW ENGINE INNODB STATUS```不会产生任何输出。
* 如果MySQL服务器使用```--innodb-read-only``` [1779]选项启动，但数据目录仍在可写介质，root用户仍然可以执行DCL操作,如```GRANT```和```REVOKE```。
* 更改那些通常会改变写操作行为的配置选项，对运行在只读模式的服务器没有影响。
* ```MVCC```强制关闭隔离级别。所有查询读到的是最新版本，因为更新和删除是不可能的。
* 无需用到回滚日志(```undo log```)。禁用```innodb_undo_tablespaces``` [1788]及```innodb_undo_directory``` [1787]配置选项。

#### 14.2.5.2. Redo Log文件大小的限制提高
以前，InnoDB Redo Log文件的总大小限制是4GB。从MySQL5.6.3开始，这个大小限制提高到512GB。

不需要任何特殊的升级或文件格式就可以使用此功能。记录额外尺寸信息的字节已经在InnoDB系统表空间中保留，并设置为零。

如果你开发与InnoDB逻辑序列号(```logical sequence number``` ```LSN```)交互的应用程序，请修改你的代码，使用有保障的64位变量来存储和比较LSN，不要使用32位变量。

#### 14.2.5.3. InnoDB表的2-Byte排序规则id
InnoDB表可以使用大于255的排序规则id。目前，这个范围内的排序规则id都是用户定义的。例如，现在可以创建以下InnoDB表，然而在以前，排序规则id 359是已经超出了InnoDB支持的范围。
	
	sql> show collation like 'ucs2_vn_ci';
	+------------+---------+-----+---------+----------+---------+
	| Collation | Charset | Id | Default | Compiled | Sortlen |
	+------------+---------+-----+---------+----------+---------+
	| ucs2_vn_ci | ucs2 | 359 | | | 8 |
	+------------+---------+-----+---------+----------+---------+
	1 row in set (0.00 sec)
	mysql> create table two_byte_collation (c1 char(1) character set ucs2 collate ucs2_vn_ci)
	-> engine = InnoDB;
	Query OK, 0 rows affected (0.16 sec)
	
#### 14.2.5.4. Barracuda文件格式
InnoDB已经开始使用命名的文件格式来提高在升级、降级以及异构系统运行不同级别的MySQL时的兼容性。许多InnoDB的重要特性，例如表压缩和更有效的BLOB的存储格式：```DYNAMIC```行格式，就需要使用Barracuda文件格式创建表。以前的文件格式没有名字，现在被称为Antelope。

使用配置参数```innodb_file_format``` [1752]启用Barracuda文件格式，这样在创建新表的时候，就会使用Barracuda文件格式。这个参数同时也决定了新创建的表或索引是否可以使用压缩或```DYNAMIC```行格式。

这项新特性会导致MySQL 5.1以及之前版本的内置InnoDB无法访问数据库，如需要禁用这项新特性，请忽略```innodb_file_format``` [1752]的设置或设置成Antelope格式。

可以在命令行启动mysqld时设置```innodb_file_format``` [1752]的值，也可以在选项文件my.cnf(Unix操作系统)或my.ini(Windows)中设置。也可以使用```SET GLOBAL```语句动态修改设置。

更多关于文件格式管理的信息，请参阅5.4.7章节, “InnoDB文件格式管理”。

#### 14.2.5.5. 动态修改系统配置参数
MySQL 5.5和更高版本中，修改某些系统配置参数，不需要关闭或重启服务器，然而在MySQL 5.1和更低版本中必需要重启服务器才能生效。这项改进大大增加了服务器的正常运行时间，也使得测试和设计原型SQL及应用程序代码变得更容易。下面的章节将详细讲解这些参数。

##### 14.2.5.5.1. 动态修改```innodb_file_per_table```
从MySQL 4.1版本开始，InnoDB表在磁盘上有两种存储方式，一种方式是在共享的系统表空间上创建表及其索引，这种方式表将会物理存储在```ibdata```文件中。另外一种方式是在独立表空间(.ibd文件)上创建表及其索引。每个InnoDB表的存储位置是由建表时的配置参数```innodb_file_per_table``` [1754]决定的。

在MySQL 5.5和更高版本中，配置参数```innodb_file_per_table``` [1754]是动态的，可以使用```SET GLOBAL```命令设置为ON或OFF。而以前的版本中，唯一的办法是在MySQL配置文件(my.cnf或my.ini)中设置这个参数，修改它需要关闭和重启服务器。

默认设置是OFF，所以新表和索引在系统表空间中创建。动态修改该参数需要SUPER权限，修改后所有连接会立即生效。

如果建表的时候```innodb_file_per_table``` [1754]是启用的，并且使用了Barracuda文件格式，TRUNCATE操作会将表的磁盘空间返还给操作系统。Barracuda文件格式支持表压缩和DYNAMIC行格式等特性。如果建表的时候```innodb_file_per_table``` [1754]是禁用的，这些特性将不可用。如果现有的表想使用这些特性，你可以打开file-per-table设置并在这些表上运行```ALTER TABLE t ENGINE=INNODB```操作。

当重新定义InnoDB表的主键的时候，会使用当前的```innodb_file_per_table``` [1754]和```innodb_file_format``` [1752]设置来重建表。就像在```InnoDB存储引擎的快速创建索引```中描述的一样，增加或删除InnoDB二级索引不会对此有影响。如果创建二级索引的时候没有重建表，索引会存储在与表数据相同的文件中，而与当前的```innodb_file_per_table``` [1754]设置无关。

##### 14.2.5.5.2. 动态修改```innodb_stats_on_metadata```
在MySQL 5.5和更高版本中，可以在运行时动态修改```innodb_stats_on_metadata``` [1782]的设置，用来控制在执行InnoDB元数据语句时是否收集统计信息。可能使用以下语句来修改设置，```SET GLOBAL innodb_stats_on_metadata=mode```，mode可以是ON或OFF(1或0)。修改此设置需要SUPER权限，修改后会立即影响所有连接。

与此设置相关的章节是14.2.5.8，“控制优化器的统计评估方式”。

##### 14.2.5.5.3. 动态修改```innodb_lock_wait_timeout```
一个事务在放弃和回滚一个语句之前等待资源的时间，是由配置参数```innodb_lock_wait_timeout``` [1765]决定的。(在MySQL 5.0.12和更早版本中，整个事务会被回滚，不只是当前语句。)应用程序可以重试当前语句(通常在等待一段时间之后)，或回滚整个事务之后再重试。

等待超时后，会返回以下错误:

	ERROR HY000: Lock wait timeout exceeded; try restarting transaction

在MySQL 5.5和更高版本中，配置参数```innodb_lock_wait_timeout``` [1765]可以在运行时使用SET GLOBAL或SET SESSION设置。更改全局设置需要SUPER权限并且会影响随后连接的所有客户端。任何客户端也可以修改```innodb_lock_wait_timeout``` [1765]的SESSION设置，只影响当前客户端。

在MySQL 5.1和更早版本中，唯一的办法是在MySQL配置文件(my.cnf或my.ini)设置这个参数，并且修改它需要关闭和重启服务器。

##### 14.2.5.5.4. 动态修改```innodb_adaptive_hash_index```
就像14.2.4.2.14章节--”控制自适应哈希索引”中描述的，在有些情况下，可以根据负载情况，动态地启用或禁用InnoDB的自适应哈希索引来提高查询性能。

可以使用配置选项```innodb_adaptive_hash_index``` [1738]禁用自适应哈希索引。默认是启用的。可以使用SET GLOBAL语句修改这个参数而不需要重启服务器。修改此设置需要SUPER权限。

禁用自适应哈希索引会立即清空哈希表。哈希表为空时，普通操作都可以继续，使用哈希表访问索引的查询会被B-trees代替。当再次启用自适应哈希索引时，哈希表会在正常操作时被再次填充。

#### 14.2.5.6. TRUNCATE TABLE 回收空间
当截断一个存储在独立.ibd文件中的表时(创建表时启用了```innodb_file_per_table``` [1754])，并且此表没有外键约束，此表将被删除并在一个新的.ibd文件中重建。这样操作的速度比逐删除要快得多，并且截断表后该表磁盘空间会归还给操作系统以便重用。由于没有大块未使用的空间在系统表空间，物理备份也会很小。相反地，如果使用InnoDB系统表空间，截断表后的空间只会归还给InnoDB。

MySQL 5.1和更早的版本中，可以重用已存在的.ibd文件，但这样只释放出空间到InnoDB，而没有到操作系统。需要注意的是，当截断表时，受TRUNCATE TABLE语句影响的行数只是个随机数。
	
> ### **注意** ###
> 如果在同一个表的两列之间有一个外键约束，仍然可以使用截断表这样的快速技术。
> 
> 如果在被截断的表和其他表之间有外键约束，截断操作将会失败。与之前的行为不同的是，将会把截断操作转换为删除所有行的操作，并且将触发子表的ON DELETE操作。

#### 14.2.5.7. InnoDB 严格模式（Strict Mode）
为防止SQL中因疏忽产生的拼写错误和语法错误或各种操作模式和SQL语句的组合所产生的其他意想不到的后果，InnoDB提供了“严格模式”（Strict Mode）的操作。在这种模式下，InnoDB在某些情况下会报错而不是发出警告并执行特定的语句(可能是无意识的行为)。这个模式和MySQL中的```sql_mode```类似，```sql_mode```控制什么样的SQL语法的能被MySQL接受，决定是否安静地忽略错误，或者校验输入语法和数据值。因为InnoDB严格模式是相对较新的我，一些在早期MySQL版本中执行没有错误的语句在严格模式下可能会产生错误，除非你禁用严格模式。

InnoDB严格模式的设置会影响CREATE TABLE, ALTER TABLE 和 CREATE INDEX语句的语法错误的处理。严格模式也会启用记录长度检查功能，所以插入或更新操作不会因为记录太大而无法在给定的页中存储而导致错误。

如果在执行CREATE TABLE, ALTER TABLE 和 CREATE INDEX语句时使用了```ROW_FORMAT```和```KEY_BLOCK_SIZE```子句，Oracle建议启用```innodb_strict_mode``` [1784]。
如果没有启用严格模式，InnoDB创建表或索引的时候将忽略冲突的子句，只在消息日志中产生一个警告。这样创建的表可能并不是你想要，比如当你想创建一个压缩表的时候，结果创建了一个非压缩的表。如果启用了InnoDB严格模式，这种情况将直接产生一个错误，表或索引不会创建，避免了后面的麻烦。

InnoDB 严格模式的设置使用配置参数```innodb_strict_mode``` [1784]，可以是ON或OFF，可以在启动mysqld的命令行上或配置文件my.cnf或my.ini中设置，也可以在运行时使用```SET [GLOBAL|SESSION] innodb_strict_mode=mode```语句（mode是ON或OFF）来启用或禁用InnoDB 严格模式。改变GLOBAL设置需要SUPER特权，修改后会影响所有随后连接的客户端。修改```innodb_strict_mode``` [1784]的SESSION设置，只影响当前客户端。

#### 14.2.5.8. 控制优化器的统计评估方式
基于索引的相对可选择性，MySQL查询优化器使用索引键分布情况的估算统计值决定在执行计划中使用或不使用该索引。过去，InnoDB通常从索引中取8个随机页用以获取该索引的估算基数(即：索引中的唯一值数量)。（这种索引页采样技术经常被称为“索引采样）。这么少的样本页往往是不够的，可能会给出索引不精确的可选择性估计，最终导致优化器选择糟糕的索引。

给你控制质量的统计估计(因此更好的信息
查询优化器),可以改变数量的采样页面使用参数
innodb统计样页[1783]。 此前,抽样页的数量总是8,
这可能不足以产生一个准确的估计,导致贫困指数选择的查询吗
优化器。这种技术尤其重要,大表和表用于连接。不必要的
全表扫描的表可以这样明显的性能问题。看到部分8 2 1 20,“如何
避免全表扫描”这样的查询调优技巧。

你可以设置全局参数innodb统计样页[1783],在运行时。默认
为这个参数值是8,保留相同的行为在过去的版本。


注意
的价值属性示例页面innodb[1783]影响指数
抽样为所有InnoDB表和索引。有以下的可能
当你改变重大影响的指数样本大小:
•小值像1或2可能导致非常不准确的估计的基数。
•增加innodb统计样页[1783]值可能需要
更多的磁盘读取。值远远大于8(例如100),会造成一个大
放缓的时间打开一个表或执行显示表
状态。
•优化器可能会选择非常不同的查询计划基于不同
估计的索引的选择性。

禁用基数估计为元数据报表如显示表状态,执行
声明中设置全局属性元数据innodb =掉(或0)。可以设置这个选项
动态也相对较新。

所有InnoDB表都开了,这个数据是为所有相关的索引重新估计,当
mysql客户端启动如果汽车重复设置是设置(默认)。改善起动时间
的mysql客户端,你可以把汽车重新处理掉。汽车改变特性允许自动的名字
完成数据库、表和列的名称为交互式用户。

无论价值属性示例页面innodb[1783]最适用于一个系统,设置选项
和把它在那个值。选择一个值,结果在合理准确的估计对所有表
在你的数据库不需要过度的I / O。因为这个数据是自动重新计算
在不同的时代除了在执行分析表,是没有意义的增加
该指数样本大小、运行分析表,然后再减少样本的大小。更准确
统计计算分析使用一个高价值的数据示例页面innodb[1783]
可以擦去后。

虽然它不可能指定样本的大小在一个表基础上,较小的表一般
需要更少的指数样本比大表做。如果你的数据库有许多大的表,可以考虑
使用更高的价值属性示例页面innodb[1783]比你大多较小
表。


#### 14.2.5.9. Better Error Handling when Dropping Indexes

为获得最佳性能和DML语句,InnoDB需要索引存在外键上
列,以便更新和删除操作在父表可以很容易地检查是否
相应的行存在于子表。MySQL创建或下降时自动等指标
需要,作为副作用的创建表,创建索引和ALTER TABLE语句。

当你删除索引,InnoDB检查是否该指数不用于检查一个外键
约束。它仍然是好的下降指数如果有另一个指标,可用于执行相同的
约束。InnoDB阻止你放弃过去的指数,可以执行一个特定的参考
约束。

消息,报告这个错误条件是:

	ERROR 1553 (HY000): Cannot drop index 'fooIdx':
	needed in a foreign key constraint

这个消息是友好的比早期的消息它取代:

	ERROR 1025 (HY000): Error on rename of './db2/#sql-18eb_3'
	to './db2/foo'(errno: 150)

类似的变化在错误报告适用于一个试图删除主键索引。表
没有一个明确的主键,创建了一个隐式的聚集索引InnoDB使用第一列
表声明的独特和非空。当你把这些索引,InnoDB
自动复制表和重建索引使用不同的独特的非空群
列或一个系统生成的关键。因为这个操作变更主键,它使用慢
方法复制表和重新创建索引,而不是快速创建索引技术
从剖面5 5 6”,实现细节的在线DDL”。

以前,为了删除一个隐式的聚集索引(第一个独特的非空指数)没有如果
这个表不包含主键:

	ERROR 42000: This table type requires a primary key

#### 14.2.5.10. More Compact Output of SHOW ENGINE INNODB MUTEX

声明显示引擎INNODB互斥显示信息和rwlocks INNODB互斥锁。
虽然这些信息是有用的在多核系统调优,数量的输出可以
是压倒性的系统上的一个大缓冲池。有一个互斥锁和一个rw锁在每个16 k
缓冲池的块,还有65536块/ gb。它是不太可能的,单个块互斥或
rw锁从缓冲池可以成为一个性能瓶颈。

显示发动机INNODB互斥现在跳过了互斥体和rw锁块的缓冲池。它也
没有列出任何互斥或rw锁从未招待(os等待= 0)。因此,显示引擎
INNODB互斥只显示信息以外的互斥体和rw锁的缓冲池
造成至少一个操作系统等。


#### 14.2.5.11. More Read-Ahead Statistics

中描述的部分14 2 4 2 16,“改变的预读取算法”,一个提前读请求
是一个异步I / O请求,页面发布预期将在不久的将来使用。
知道有多少页是通读这预读机制,和他们有多少人
赶出缓冲池没有被访问过,可能是有用的帮助调整参数
innodb预读阈值[1778]。

显示发动机状态输出显示全球INNODB
状态变量innodb缓冲池预读[607]和
innodb缓冲池预读驱逐[607]。这些变量显示页面的数量
进入缓冲池通过预读请求,这样的页面数量赶了出来
缓冲池没有分别被访问。这些计数器提供全局值自
最后重启服务器。

显示发动机状态也显示了INNODB速度页面读取预读
和速度,这样的页面没有被访问驱逐。每秒的平均值是
根据统计信息收集自上次调用显示引擎INNODB地位和是
显示在缓冲池和内存部分的输出。
