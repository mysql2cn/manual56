# 5.2.5 慢查询日志

### 5.2.5 慢查询日志

慢查询日志是指执行超过`long_query_time`参数设定的时间阀值(秒)和需要检查超过`min_examined_row_limits`行的数据的SQL语句，`long_query_time`的最小值和默认值分别是0和10，该值可以指定的最小界限是微秒，对于记录到文件中，写入的时间将包含微秒部分，对于记录到表中，只写入整数倍时间，微秒部分将被忽略。

默认情况下，不会记录管理语句，也没有记录不使用索引的查询语句。这种行为是可以使用 `--log-slow-admin-statement` 和 `--log_queries_not_using_indexes` 进行改变的。后面会有描述。

获得初始表锁定的时间不算执行时间。`mysqld`将语句执行完并且所有锁释放后才记入慢查询日志，记录顺序可以与执行顺序不相同。

默认情况下，慢查询日志是被禁用的，要明确指定初始慢查询日志的值，使用 `--slow_query_log[={0|1}]`,不带参数或者参数为1， `--slow_query_log`使用日志，参数为0，则此选项禁用日志。要指定日志文件名称，使用 `--slow_query_log_file=file_name`，要指定日志的输出目标，使用`--log-output`(如第5.2.1节中所描述的，"选择通用查询和慢查询日志输出目标")。

如果没有指定慢查询日志文件名，默认的名字是`host_name-slow.log`，服务器在数据目录中创建这个文件，除非给出一个指定到不同目录下的绝对路径。

要在运行时禁用或者启用慢查询日志或者改变日志文件名，使用全局系统变量`slow_query_log`和`slow_log_file`，设置`slow_query_log`为0(或`OFF`)来禁用日志或者1(或`ON`)来启用日志，设置`slow_query_log_file`为指定的日志文件名，如果日志已经打开，它将被关闭并且打开新文件。

当启用慢查询日志，服务器将输出写入到由`--log-out`选项或系统变量`log-output`所指定的任何目标，如果启用了日志，服务器打开日志文件并且写入启动信息，然而，更多地记录查询文件并不会发生，除非设置日志文件输出地。如果目标是`NONE`,即使启用慢查询日志，服务器并不会写入查询信息。如果日志输出目标的值不包含FILE,那么设置日志文件名并不会影响到日志功能。

如果你使用 `--log-short-format`选项，服务器将更少的信息写入到慢查询日志(和二进制日志)。

要在写入到慢查询日志中包含慢管理语句，使用`--log-slow-admin-statement` 服务器选项，管理语句包括`ALTER TABLE`, `ANALYZE TABLE`, `CHECK TABLE`, `CREATE INDEX`, `DROP INDEX`, `OPTIMIZE TABLE`, 和`REPAIR TABLE`。

要将语句中不使用索引行的查询记录到慢查询日志中，启用`log_queries_not_using_indexes`系统变量，当记录像这样的查询时，慢查询日志会增长得很快，通过设置`log_throttle_queries_not_using_indexes`系统变量来限制查询率是可行的。默认情况下，这个值是0，意味着没有限制，正值限制日志记录每分钟内不使用索引的查询的次数，第一个这样的查询内打开一个60秒的窗口服务器日志查询给定的限制，然后会抑制其他查询。如果在窗口结束时有被抑制查询，服务器将对它们的总用时进行记录总结。下一个60秒的窗口时，服务器开始记录下不使用索引的查询。

服务器使用的控制参数按以下顺序来确定是否在慢查询日志中写一条查询记录：

1. 查询必须不是一个管理语句，或者必须通过`--log-slow-admin-statements`语句指明。
2. 查询必须超过 `long_query_times`秒，或者启用`log_queries_not_using_indexes`和查询不使用索引行。
3. 必须检查至少 `min_examined_row_limit`行。
4. 查询不能抑制`log_throttle_queries_not_using_indexes`的设置。

服务器并不会将处理查询缓存的查询写入到慢查询日志中，因为该表只有0行或者1行，所以没有查询会因为索引的存在而受益。

默认情况下，从复制服务器不会将重复查询写入到慢查询日志中，要改变这一点，使用`--log-slow-slave-statement`服务器选项。

从MySQL 5.6.3开始，写入到慢查询日志中的语句中的密码会被服务器以不是明文的方式改写，在MySQL 5.6.3之前，语句中的密码不会被改写所以应该保护慢查询日志，请参考6.1.2.3节，"密码和记录"。

慢查询日志可以用来找到执行时间长的查询，可以用于优化。但是，找到又长又慢的查询日志会很困难。要想容易些，你可以使用`mysqldumpslow`命令获得日志中显示的查询摘要来处理慢查询日志。请参考4.6.9节，"`mysqldumpslow` -- 总结慢查询日志文件"。
