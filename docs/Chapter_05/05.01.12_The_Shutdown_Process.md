# 5.1.12 关机进程

### 5.1.12 关机进程

服务器关机进程按照如下步骤:

1. 启动关机进程

	可以用多种方法启动服务器的关闭。例如，拥有`SHUTDOWN`权限的用户可以执行`mysqladmin shutdown`命令。`mysqladmin`可以用于所有支持MySQL的平台上。与其它操作系统相关的关闭开始方法可能还有：在Unix中，当接收到SIGTERM信号后，服务器关闭。对于在Windows中作为服务运行的服务器，当服务管理器让它关闭时，则关闭。

2. 服务器根据需要需要创建关闭线程

	根据开始关闭的方式，服务器可以创建线程来处理关闭进程。如果客户端需要关闭，则创建关闭线程。如果收到SIGTERM信号后关闭，信号线程可以自己关闭，或者创建单独的线程来完成。如果服务器尝试创建关闭线程而不能创建(例如，内存耗尽)，它会在错误日志中给出诊断消息：

	> Error: Can't create thread to kill server

3. 服务器停止接收新的连接

	在关闭过程中要想防止启动新活动，服务器停止接收新的客户端连接。它将关闭它帧听的网络连接：TCP/IP端口、Unix套接字文件、Windows命名管道和在Windows中的共享内存。

4. 服务器终止当前的活动

	对于每个与客户端连接相关的线程，与客户端的连接被中断，线程被标记为“杀掉的”。当线程注意到此类标记后则线程终止。空闲连接的线程很快终止。当前正处理查询的线程定期检查它们的状态，终止的时间较长。关于线程终止的详细信息，请参考13.7.6.4节"`KILL`语法"，特别是关于对`MyISAM`表的杀掉的`REPAIR TABLE`或`OPTIMIZE TABLE`操作。

	对于有打开事务的线程，事务被回滚。请注意如果某个线程正在更新非事务表，多行`UPDATE`或`INSERT`等操作会使表部分更新，因为操作在完成前会终止。

	如果服务器是主复制服务器，与当前连接的从服务器相关的线程的处理方式同其它客户端线程一样。即每个线程被标记为杀掉的，在下次检查他的状态后会退出。

	如果服务器是从复制服务器，在客户端线程标记为杀掉的之前，激活的I/O和SQL线程被停止。SQL线程允许先结束它当前的语句(以避免造成复制问题)然后停止。如果此时SQL线程正位于事务中部，则服务器等待直到当前的复制事件组(如果有)执行完成或者用户发出一个`KILL QUERY`或`KILL CONNECTION`语句。请参考13.4.2.6节"`STOP SALVE`语法"，由于非事务性语句不能回滚，为了保证碰撞安全复制，应该使用事务性表。

	注意: 

	> 为了在从复制服务器上保证碰撞安全复制，你还必须从复制服务器上运行 `--relay-log-recovery`进行启用。请参考16.2.2节，"复制传递和状态日志"。

5. 停止服务器或关闭存储引擎

	在该阶段，表缓存被清空，所有打开的表被关闭。

	每个存储引擎执行它管理的表需要的任何动作。`InnoDB`将它的缓冲池清空到硬盘上（除非`innodb_fast_shutdown`值为2），将当前的LSN写入表内，并终止自己的内部线程。`MyISAM`清空任何挂起的表索引写操作。

6. 服务器退出。
