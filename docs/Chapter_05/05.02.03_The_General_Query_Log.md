# 5.2.3 通用查询日志

### 5.2.3 通用查询日志

通用查询日志记录`mysqld`做的事情，当建立客户端连接或者断开的时候，服务器会将信息写入到日志中，以及服务器会记录从客户端接收到的每一条SQL语句，当你怀疑在客户端发生了错误并想确切地知道该客户端发送给`mysqld`的语句时，该日志可以非常有用。

`mysqld`按照它接收的顺序记录语句到查询日志。这可能与执行的顺序不同。这与更新日志和二进制日志不同，它们在查询执行后，但是任何一个锁释放之前记录日志。此外，查询日志还包含所有语句，而二进制日志不包含只查询数据的语句。

当使用基于语句的记录，所有的语句会被写入到查询日志中去，但是当使用基于行的记录，更新发送行更改，并不是SQL语句，当`binlog_fornat`的值是`ROW`时这些语句从来不会被写入到查询日志，一个给定的更新同样不会被写入到查询日志中当这个变量的值是`MIXED`,这取决于所使用的语句，请参考16.1.2.1节 "基于语句和基于行复制的优点和缺点"。

默认情况下，通用查询日志是被禁用的，要明确指定初始化通用查询日志的状态，使用 `--general_log[={0|1}]`，如果没有指定参数或者参数值为1， `--general_log`启用日志，如果参数值为0，这个选项会禁用日志，要指定文件名，使用 `--general_log_file=file_name`, 要指定日志输出目标，使用 `--log-output`(如第5.2.1节中所描述的，"选择通用查询和慢查询日志输出目标")

如果你没有指定通用查询日志文件名，默认文件名是`host_name.log`, 服务器将会在数据目录下创建这个文件，除非给出一个指定到不同目录下的绝对路径。

要在运行时禁用或者启用通用查询日志或者改变日志文件名，使用全局系统变量`general_log`和`general_log_file`，设置`general_log`为0(或`OFF`)来禁用日志或者1(或`ON`)来启用日志，设置`general_log_file`为指定的日志文件名，如果日志已经打开，它将被关闭并且打开新文件。

当启用通用查询日志，服务器将输出写入到由`--log-out`选项或系统变量`log-output`所指定的任何目标，如果启用了日志，服务器打开日志文件并且写入启动信息，然而，除非设置日志文件的输出目标，否则并不会记查询文件。如果目标是`NONE`, 即使启用慢查询日志，服务器也并不会写入查询信息。如果日志输出目的地的值不包含`FILE`,那么设置日志文件名并不会影响到日志功能。

服务器重新启动和日志刷新不会产生新的一般查询日志文件(尽管刷新关闭并重新打开一般查询日志文件)。要重命名文件和创建新文件，使用如下命令:

> shell> mv host_name.log host_name-old.log
> 
> shell> mysqladmin flush-logs
> 
> shell> mv host_name-old.log backup-directory

在Windows下，使用`rename`替代`mv`。

你可以在运行时通过禁用日志的方式重命名通用查询日志:

> SET GLOBAL general_log = 'OFF';

禁用日志，通过外部命令重命名日志文件，例如，在命令行中重命名。然后再次启用日志：

> SET GLOBAL general_log = 'ON'

这个方法可以在任何平台下工作而不需要重启服务器。

会话变量`sql_log_off`可以在当前连接中设置为`ON`或者`OFF`来禁用或者启用通用查询日志功能。

从MySQL  5.6.3开始，写入到通用查询日志中的语句中的密码会被服务器以不是明文的方式改写，通用查询日志中的密码重写是通过` --log-low`选项来支持的，这个选项对于诊断可能是有用的，可以看见来自服务器的确切文本，但是，出于安全目的，不建议在生产环境中使用。

在MySQL 5.6.3之前，语句中的密码并不会被重写和通用查询日志应该被保护，请参考6.1.2.3节，"密码和记录"。
