###13.3.7. XA 事务

[13.3.7.1. XA Transaction SQL Syntax](/docs/Chapter_13/13.3.7.1_XA_Transaction_SQL_Syntax.md "13.3.7.1")  
[13.3.7.2. XA Transaction States](/docs/Chapter_13/13.3.7.2_XA_Transaction_States.md "13.3.7.2")

MySQL当中InnoDB存储引擎支持XA事务。MYSQL的XA是按照X/Open CAE 文档中 ___分布式事务处理:The XA Specification___ 的描述来实现的。该文档由开源组织提供。链接地址为[http://www.opengroup.org/public/pubs/catalog/c193.htm](http://www.opengroup.org/public/pubs/catalog/c193.htm "www.opengroup.org")。关于XA的相关限制的描述可详见：[E.6, “Restrictions on XA Transactions”]()。

XA事务对客户端没有任何特别的要求。对MYSQL来说在以XA关键字开始的SQL语句就是XA的接口（interface）。因为不需要链接（linked)客户端的库（library），故兼容老的MYSQL客户端。

当前，MYSQL Connector/J 5.0.0 或更高版本直接支持XA,它通过一个类（class)接口来处理 Xan SQL语句。

XA支持分布式事务，这意味着它允许将一个全局事务分成多个事务进行处理。一般来说都是RDBMS(关系型数据库）来为分布式事务提供事务资源，当然其他环境也可以。

一个XA全局事务往往涉及到多个事务性操作，所有事务性操作都必须作为一个组来提交或回滚。这本质上是对事务ACID四大特性的扩展。一个具有事务ACID属性的全局操作，如果它包含了多个符合ACID特性的事务，那么所有的事务会被同时执行。对于非分布式事务，事务隔离级别使用可重复读（ REPEATABLE READ ）即可。但是对于分布式事务必须使用序列化（ SERIALIZABLE）隔离级别来保证事务的ACID特性。

分布式事务应用举例：

* 将消息服务和关系型数据库系统(RDBMS)作为一个集成管理工具进行整合的应用可视为分布式事务处理应用。它可以将事务处理与消息的发送，接收和消息处理结合起来，并且保证所有的处理过程都在一个全局事务当中。你可以把这样的处理过程看做是“事务邮件”。

* 一个应用执行的操作涉及到很多数据库(比如MYSQL和ORACLE数据或多个MYSQL数据库），并且所有涉及到多个数据库的操作都必须当作全局事务的一部分，而不是将每个操作作为个自数据库的独立事务来处理。

* 银行一般会将客户的账户信息保存在关系型数据库（RDBMS）中，并且通过ATM机分散式的接受存款。在这种情况下，仅仅使用关系型数据库（RDBMS)是无法确保银行的每台ATM都机能正确的反映客户账户的变化情况。这个时候需要一个全局事务管理器来协调ATM机和数据库资源以保证事务的最终一致性。

应用在使用分布式事务当中所涉及到资源管理器和事务管理器的情况介绍如下：

* 资源管理器（简称RM）提供访问事务的资源。数据库就是资源管理器的一种,它必须允许资源管理器能够对事务的提交或回滚事务进行管理。

* 事务管理器（简称TM）负责协调组成全局事务中的每个分支事务 ，它与资源管理器进行通信以处理每个这样的分支事务。每个独立的事务都做为全局事务的一个分支，全局事务和它的分支都由命名scheme来标识，稍后将做详细介绍。

MYSQL对XA的实现方式是将MYSQL 服务层（MYSQL server)作为一个资源管理器来管理每个XA事务，而MYSQL客户端则被作为一个事务管理器来使用。

要完成一个分布式事务就必须知道需要调用哪些组件，并且在事务提交或回滚的时候保证每个组件都处于一个相同的状态。因此，所有组件的提交或回滚都必须作为原子性操作来处理。即，所有的组件要么同时提交要么同时回滚。分布式事务处理必须充分考虑到每个组件可能失效或网络故障的情况。

分布式事务执行过程使用两段式（2PC）提交方式。两段式提交发生在分布式分支事务的执行过程中。

1. 第一阶段，所有的分支事务进行提交准备。即，事务管理器告诉每个分支准备进行提交。这意味着，每个资源管理器都管理着每个分支的状态记录；每个分支的状态可以表明分支事务是否可以进行提交；所有分支的状态也用于第二阶段的提交中。

2. 第二阶段，事务管理器告诉资源管理器是否可以进行提交或回滚。 在准备阶段如果所有的分支事务都表示可以进行提交，那么所有的事务都会被通知进行提交。如果任何分支事务在准备阶段表示不能提交，那么所有的分支事务都将进行回滚。

在某些情况下，分布式事务可能会进行一段式(one-phase 或 1PC)提交。比如，如果事务管理器发现分布式事务只有一个事务资源（即，一个分支事务），那么事务的准备和提交会同时完成。











