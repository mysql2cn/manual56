# Summary_of_MySQL_Cluster_Start_Phases

17.5.1 MySQL集群启动阶段汇总   
本节提供了当MySQL集群数据节点开始时的一个简化的大纲涉及的步骤，更完整的信息可以在mysql集群启动阶段的ndb内部指南里面找到。这些阶段跟管理客户端的node_id状态报告一样（请查看 17.5.2小节, “mysql集群管理客户端命令”），这些启动阶段也可以在ndbinfo.nodes表的start_phase字段可以查看到。   

启动类型  有许多不同的启动类型和模式，见如下的列表：   
• 初始启动. 在所有节点上与干净的文件系统一起启动簇。这或是出现在首次启动簇时，或是使用“--initial”选项重启簇时。   
[备注]当用”initial”选项启动簇数据节点的时候，数据文件不会被移走。   
• 系统重启  集群启动并且读取存储在数据节点上面的数据。当集群使用完正常关闭，并希望从集群的停止点恢复集群操作时?。   
• 节点重启  当集群正在运行的时候，在线启动一个集群节点。   
• 节点初始化重启  跟节点重启一样，除了初始化的时候使用新的文件系统。   
安装和初始化（阶段-1） 启动之前，必须对每个节点进行初始化操作（ndbd进程）。这包括下述步骤：   
1.    获取节点ID。   
2.    获取配置数据。   
3.    为节点间的通信分配端口。   
4.    根据从配置文件获得的设置分配内存。   
当数据节点和sql节点第一次连接管理节点的时候，会保存一个集群节点ID，用来确保其他节点不会使用同一个ID，此ID会一直保留直到节点成功连接到集群并且至少一个ndbd报告节点已连接。这个节点ID的存在是通过数据节点(或sql节点)与ndb_mgmd之间的连接来维持的。   

完成了对各节点的初始化操作后，将进入集群启动进程。在该进程中，簇将经历下述阶段：   
• 阶段0  NDBFS和NDBCNTR块启动(请参考NDB核心块http://dev.mysql.com/doc/ndbapi/en/ndb-internals-kernel-blocks.html)，当使用“--initial”选项启动集群时，数据节点上的文件系统会被清空。   
• 阶段1  在这里，所有剩余NDB内核块启动，建立MySQL集群连接，建立节点间的通信，启动簇“心跳”，在节点重启的时候，会检查节点API连接。   
	[备注] 这里，当一个或多个节点挂在阶段1,其余的节点挂在第二阶段,这通常显示是网络问题。有可能是一个或者多个集群主机有多个网络接口，另一个常见的问题导致这个条件是阻塞的TCP / IP端口需要集群节点之间的通信，对于后者通常是由于防火墙配置错误   
• 阶段2  NDBCNTR核心块检查所有启动节点的状态。选中主节点，初始化集群数据库文件。   
• 阶段3  建立DBLQH和DBTC内核模块之间的通讯。此时启动类型是determined；如果是重启，DBDIH块获准执行重启   
• 阶段4  对于初始启动或初始节点重启，将创建redo日志文件。这类文件的数目取决于参数   NoOfFragmentLogFiles的值。   

对于系统重启：   
•  读取单数据库或者所有数据库。   
•  从本地检查点读取数据。   
•  加载所有的redo信息，直至到达最近的可恢复检查点为止。   
对于节点重启，找到redo日志的末尾。   
• 阶段5  数据节点的与数据库相关的部分会开始在此阶段执行,对于首次启动或者节点首次重启,局部的检查点先执行，全局的检查点接着执行，这个阶段开始检查定期检查内存使用量,并且执行任何任何所需接受的节点。?   
• 阶段6  定义以及创建节点组   
• 阶段7  仲裁员节点被选中并且生效，然后设置备份ID，备份磁盘写入速度，节点达到这个阶段开始标记为开始，这个时候API节点(包括SQL节点)可能就去连结集群。   
• 阶段8  如果是系统重启，所有索引重建(通过DBDIH)。   
• 阶段9  重新设置节点内部启动变量。   
• 阶段100（废弃的）  以前,这是此时在节点重启或节点初始化重启,API可以连接到数据节点并开始接收事件。现在,这一节阶段是闲空的。   
• 阶段101  在这一点上,一个节点重启或节点初始化重启,事件传递任务提交给新加入的集群节点。新加入的节点负责把数据传递给对方。这一阶段也称为SUMA移交阶段。   

对于首次启动或系统重启，一旦该进程完成，将启用事务处理功能。对于节点重启或首次节点重启，启动进程的完成意味着节点现在能够成为事务协调程序。   




