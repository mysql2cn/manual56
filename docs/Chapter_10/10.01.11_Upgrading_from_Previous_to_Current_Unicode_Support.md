### 10.1.11. 从之前到现在版本升级的Unicode支持

本节介绍有关Unicode支持你可能从旧的MySQL版本升级到MySQL5.6时会面临的问题。它还提供了指导方针从MySQL5.6降级到旧版本。

在大多数方面，升级到MySQL5.6应该提出几个问题关于的Unicode使用，虽然也有一些不兼容的潜在领域。这些是主要的关注领域：

* 对于可变长的字符数据类型（`VARCHAR` 和 `TEXT` 类型），字符的最大长度为 `utf8mb4` 列少 `utf8` 列。
* 对于所有字符数据类型（`CHAR`，`VARCHAR` 和 `TEXT` 类型），最大可以被索引的字符数目 `utf8mb4` 列少 `utf8` 列。

因此，如果你想升级表从 `utf8` 到 `utf8mb4` 以充分利用增补字符的支持，它可能需要改变一些列或索引定义。

表可以用 [ALTER TABLE]() 从 `utf8` 到 `utf8mb4` 转换。假设一个表最初被定义如下：

```sql
CREATE TABLE t1 (
col1 CHAR(10) CHARACTER SET utf8 COLLATE utf8_unicode_ci NOT NULL,
col2 CHAR(10) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL
) CHARACTER SET utf8;
```

如下语句转换 `t1` 成 `utf8mb4`：

```sql
ALTER TABLE t1
 DEFAULT CHARACTER SET utf8mb4,
 MODIFY col1 CHAR(10)
   CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
 MODIFY col2 CHAR(10)
   CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL;
```

就表内容而言，从 `utf8` 转换到 `utf8mb4` 没有呈现任何问题：

* 对于一个BMP字符， `utf8` 和 `utf8mb4` 的有相同的存储特性：相同的代码值，相同长度，相同的编码。
* 对于增补字符，`utf8` 不能存储在所有的字符，而 `utf8mb4` 需要4个字节来存储它。由于`utf8` 不能存储在所有的字符，你不会有任何补充字符在`utf8` 列，你不必担心字符从旧版本的MySQL升级时转换 `utf8` 数据丢失数据的。

就表结构而言，当从 `utf8` 转换到 `utf8mb4` 时，捕获列或索引键的最大长度是不变的，就字节数而言。因此对于字符是变小了因为一个字符的最大长度4个字节代替了三个。对于 `CHAR`，`VARCHAR`，和 `TEXT` 数据类型，当转换MySQL表，看发生了什么事情：

* 检查所有的定义的 `utf8` 列，并确保他们将不会超过存储引擎的最大长度。
* 检查所有`utf8` 列上的索引 ，确保他们将不会超过存储引擎的最大长度。有时这最大可以由存储引擎增强而改变。

如果应用上述条件，你必须减少列或索引定义的长度，或继续使用 `utf8` 而不是 `utf8mb4`。

下面是一些例子可能需要结构的变化：

* `TINYTEXT` 列可以容纳255个字节，所以它最多可容纳85个3-字节或者63个4-字节字符。假定你有一个 `utf8` 的 `TINYTEXT` 列，但必须能够包含超过63个字符。你不能把它转换到 `utf8mb4` 除非你改变一个较长的数据类型，如 `TEXT` 数据类型。

    同样，一个较长的 `VARCHAR` 列可能需要改成一个更长的 `TEXT` 数据类型，如果你想从 `utf8` 转换到 `utf8mb4`。
* `InnoDB` 具有最大索引长度为767个字节，所以对于 `utf8` 或 `utf8mb4` 列，你最多可以索引255或191个字符。如果你有超过191字符的 `utf8` 的索引列，您将需要索引较少的字符数。在 `InnoDB` 表，这些列和索引定义是合法的：

    ```sql
    col1 VARCHAR(500) CHARACTER SET utf8, INDEX (col1(255))
    ```

    为了使用 `utf8mb4` 代替，索引必须变小：

    ```sql
    col1 VARCHAR(500) CHARACTER SET utf8mb4, INDEX (col1(191))
    ```

上述类型的变化是最有可能被要求只有当你有很长的列或索引。否则，你应该能够转换表从UTF8以utf8mb4，没有问题。为此，您可以通过使用ALTER TABLE如前所述，在本节过后到位升级到5.6。

下列项目总结其他潜在的不兼容领域：

* 4-字节的UTF-8（`utf8mb4`）的性能慢于3-字节的UTF-8（`utf8`）。如果你不想承受这点不利，请继续使用 `utf8`。
* `SET NAMES 'utf8mb4'` 导致连接的字符集使用4-字节的字符集。只要没有4字节字符从服务器发送的，应该没有问题。否则应用程序预计收到最大三个字节字符可能会有问题。相反，期望发送4字节字符的应用程序必须确保服务器能理解他们。
* 应用程序不能发送 `utf16`，`utf16le`，或 `utf32` 字符数据到不理解它们的旧服务器。
* 对于复制，如果字符集支持增补字符被用于主，所有的从必须很好的理解他们。如果您尝试复制从MySQL5.6的主复制到，`utf8` 的数据将被从视为 `utf8`，应该正确地复制。但你不能发送 `utf8mb4`， `utf16`，`utf16le`，或 `utf32` 数据。

    此外，牢记的一般性原则，如果主机和从机上表中有不同的定义，这可能会导致意想不到的结果。例如，限制索引键长度的差异，使得它使用 `utf8` 主机和 `utf8mb4` 从有风险。

如果你已经升级到MySQL5.6，然后再决定降级到旧版本，这些因素应用于：

* `ucs2` 和 `utf8` 的数据应该不存在问题。
* 任何定义成 `utf8mb4`，`utf16`，`utf16le`，或者 `utf32` 相关字符集将无法被旧服务器识别。
* 对于与 `utf8mb4` 字符集相关的对象定义，你可以在MySQL5.6中用 [mysqldump]() 备份出来，编辑备份文件然后改变 `utf8mb4` 实体成 `utf8`，然后重新装载文件到老的服务器去，只要在数据中没有4-字节字符。老的服务器将看到 `utf8` 在备份文件对象定义并创建使用（3-字节）`utf8` 字符集的新对象。
