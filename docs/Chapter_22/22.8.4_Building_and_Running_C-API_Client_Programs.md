## 22.8.4. 编译和运行使用了C API的客户端程序
以下几节讨论如何编译使用了C API的客户端程序。内容包括编译和链接客户端程序，编写多线程客户端程序，诊断和解决运行时问题。

#### 22.8.4.1. 编译使用了C API客户端程序
本节指导如何编译使用了MySQL C API的C语言程序。
#### 在Unix上编译MySQL客户端程序
编译包含了MySQL头函数的客户端程序时，需要指定 **-I** 选项，这样编译器才能找到相应的头文件。假设头文件的安装路径是 */usr/local/mysql/include* ，在编译命令中要使用如下选项：

```
-I/usr/local/mysql/include
```

必须在链接命令中使用 *-lmysqlclient* 选项来链接MySQL客户端程序。还需要通过指定 **-L** 选项来告诉链接器到哪个位置搜索链接库文件。假设库文件安装在 */usr/local/mysql/lib* ，链接命令中则要加上如下选项：

```
-L/usr/local/mysql/lib -lmysqlclient
```

各个系统路径可能有不同，必要时根据具体情况修改 **-I** 和 **-L** 选项。 

为了让编译更简单，可以使用 *mysql_config* 脚本。具体参考 [4.7.2，mysql_config - 打印用于编译客户端的选项]()。

*mysql_config* 能输出编译或者链接所必需的命令行选项：

```
shell> mysql_config --cflags
shell> mysql_config --libs
```

通过运行以上命令就可以得到正确的命令行选项，然后再手工分别将输出拼接到编译或者链接命令上去。或者就直接在命令行内通过反引号（`）得到 *mysql_config* 的输出：

```
shell> gcc -c `mysql_config --cflags` progname.c
shell> gcc -o progname progname.o `mysql_config --libs`
```

#### 在Windows上编译MySQL客户端
使用集成开发环境所提供的工具以指定头文件和库文件位置。

要在Windows上编译C API客户端程序，除了链接客户端库之外，还需链接ws2_32网络套接字库和Secur32安全库。

在Windows上，可以链接动态库或者静态库。静态库名是 *mysqlclient.lib* ，动态库名是 *libmysql.dll* 。另外在使用动态库时还必须链接 *libmysql.lib* 静态导入库。

要使用静态库，必须满足以下两个条件：

* 当前使用的编译客户端程序的Visual Studio版本必须和编译静态库的Visual Studio版本一致。
* 必须使用/MT编译选项以确保客户端程序静态链接C运行时。

如果客户端程序是以调试模式进行编译，而且链接的是静态调试版的C运行时（通过 **/MTd** 编译选项指定），那它也只能链接同样以调试模式编译的 *mysqlclient.lib* 静态库。如果客户端程序链接的是动态C运行时（通过 **/MD** 选项，或者调试模式 **/MDd** 选项指定），它就只能链接 *libmysql.dll* 动态库。此时不能链接静态库的。

描述链接选项的MSDN相关页面在此：[http://msdn.microsoft.com/en-us/library/2kzt1wy3.aspx](http://msdn.microsoft.com/en-us/library/2kzt1wy3.aspx)

#### 如何解决链接MySQL客户端库时出现的问题。
在MySQL5.6中，客户端库已经内置了ssl支持，因而无需在链接时指定 *-lssl* 和 *-lcrypto* 选项了。如果指定了可能会在运行的时候导致问题。

如果链接器找不到库文件，可能会发生对以 *mysql_* 为前缀的某些符号的未定义引用错误，类似这样：

```
/tmp/ccFKsdPa.o: In function `main':
/tmp/ccFKsdPa.o(.text+0xb): undefined reference to `mysql_init'
/tmp/ccFKsdPa.o(.text+0x31): undefined reference to `mysql_real_connect'
/tmp/ccFKsdPa.o(.text+0x69): undefined reference to `mysql_error'
/tmp/ccFKsdPa.o(.text+0x9a): undefined reference to `mysql_close'
```

在链接命令尾部加上 *-Ldir_path -lmysqlclient* 就能解决这个问题， *dir_path* 代表库文件所在的目录位置。运行以下命令可以得出正确路径：

```
shell> mysql_config --libs
```

*mysql_config* 命令可能还会输出其他一些必须在链接命令中指定的库。在链接命令中使用反引号就可以直接引用 *mysql_config* 的输出。例如：

```
shell> gcc -o progname progname.o `mysql_config --libs`
```

如果在链接时出现 *floor* 符号未定义的错误，可以在命令行尾部添加 *-lm* 以链接math库。类似的，如果出现对于其他函数的未定义引用错误，例如 *connect()* ，参考相关函数的手册页以决定该增加链接哪个库。

如果碰到类似下面的、对系统上不存在函数的的未定义引用错误，这通常就意味着MySQL客户端库是在与你当前系统不完全兼容的系统上编译的。

```
mf_format.o(.text+0x201): undefined reference to `__lxstat'
```

在这种情况下，你应该重新下载最新的MySQL或者MySQL Connector/C，并编译MySQL客户端库。详见[2.9，用源码安装MySQL]()和[22.5，MySQL Connector/C]()。