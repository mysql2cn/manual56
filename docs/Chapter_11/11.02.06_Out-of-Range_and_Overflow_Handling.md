## 11.2.6 超出范围和溢出处理

当MySQL存储一个超出列数据类型允许范围的数值列时，结果取决于当时的SQL模式。

* 按照SQL标准，如果启用严格的SQL模式，MySQL拒绝超出范围的值并报错，并且插入失败。

* 如果没有启动严格的SQL模式，MySQL截取值到适当的范围端点并存储所得结果来代替原值。

    当超出范围的值被指定到一个整数列上时，MySQL存储该列列类型的范围所对应的端点值。如果在TINYINT或TINYINT UNSIGNED列存储256，MySQL会分别存储127或255。

    当浮点和定点列被指定一个超出隐含指定（或默认）精度和刻度范围的值时，MySQL存储该列列类型的范围所对应的端点值。

列分配转换是由于发生截取时MySQL不在严格模式下，执行ALTER TABLE，LOAD DATA INFILE，UPDATE和多行INSERT语句时以警告报告，

当MySQL没有运行在严格模式下时，对于ALTER TABLE，LOAD DATA INFILE，UPDATE和多行INSERT语句，由于截取发生的列分配转换以警告报告。在严格模式下，这些语句都将失败，部分或全部值不会被插入或改变，取决于该表是否是事务表和其他因素。详情，参见[5.1.7节，“服务SQL模式”][05.01.07]。

在MySQL5.6中，数值表达式计算结果溢出将出现报错。例如，BIGINT指定的最大值是9223372036854775807，所以下面的表达式产生一个报错：

```
mysql> SELECT 9223372036854775807 + 1;
ERROR 1690 (22003): BIGINT value is out of range in '(9223372036854775807 + 1)'
```

这时为保证执行成功，将该值转换为无符号；

```
mysql> SELECT CAST(9223372036854775807 AS UNSIGNED) + 1;
+-------------------------------------------+
| CAST(9223372036854775807 AS UNSIGNED) + 1 |
+-------------------------------------------+
| 9223372036854775808                       |
+-------------------------------------------+
```

是否发生溢出取决于操作数的范围，所以对于前面的表达式可以采用使用精确值计算的方式处理，因为DECIMAL类型比整形有更大的取值范围：

```
mysql> SELECT 9223372036854775807.0 + 1;
+---------------------------+
| 9223372036854775807.0 + 1 |
+---------------------------+
| 9223372036854775808.0     |
+---------------------------+
```

整数值之间的差，当其中一个为UNSIGNED，默认情况下将产生一个无符号的结果。在MySQL5.5.5之前，如果结果将是负值，那么将其转变为最大的整数值：

```
mysql> SET sql_mode = '';
mysql> SELECT CAST(0 AS UNSIGNED) - 1;
+-------------------------+
| CAST(0 AS UNSIGNED) - 1 |
+-------------------------+
| 18446744073709551615    |
+-------------------------+
```

从MySQL5.5.5开始，如果结果将是负值，那么将产生一个报错：

```
mysql> SET sql_mode = '';
Query OK, 0 rows affected (0.00 sec)
mysql> SELECT CAST(0 AS UNSIGNED) - 1;
ERROR 1690 (22003): BIGINT UNSIGNED value is out of range in '(cast(0 as unsigned) - 1)'
```

如果启用NO\_UNSIGNED\_SUBTRACTION[621]SQL模式，结果是负值：

```
mysql> SET sql_mode = 'NO_UNSIGNED_SUBTRACTION';
mysql> SELECT CAST(0 AS UNSIGNED) - 1;
+-------------------------+
| CAST(0 AS UNSIGNED) - 1 |
+-------------------------+
| -1                      |
+-------------------------+
```

如果这样的运行结果用来更新一个无符号整数列，结果截取到列类型的最大值，或如果启用NO\_UNSIGNED\_SUBTRACTION[621]，结果截取到0。在严格SQL模式下，将产生报错并且列内存不变。


[05.01.07]: ../Chapter_05/05.01.07_Server_SQL_Modes.md