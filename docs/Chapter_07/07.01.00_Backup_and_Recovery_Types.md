#  **7.1 备份和还原类型**

## **7.1 备份和还原类型**

此节描述不同还原类型的特征。

### **物理与逻辑备份**

物理备份是由从存储数据内容的目录和文件中原生拷贝组成。此类备份适合故障发生时能够及时恢复，数据量大，内容重要的数据库。逻辑备份保存了能够代表数据库逻辑结构的信息（创建数据库，创建表语句）和内容（插入语句或分隔文本的文件）。此备份类型适合数据量较少的数据，对于这些数据，你可能需要编辑数值，表结构或者在不同的机器结构上重建数据。

物理备份的方式有三个特性：

* 此备份是由数据库文件和目录的准确复制所组成。典型的情况它可以全拷贝或者部分拷贝MySQL数据目录。
* 由于物理备份只涉及到文件拷贝而没有数据转变，所以它比逻辑备份方式更快。
* 物理备份比逻辑备份有更多的压缩。
* 因为备份速度和紧凑性对于繁忙重要的数据库是很重要的，所以MySQL企业版备份产品施行物理备份。关于MySQL企业备份产品，详见[24.2节，"MySQL企业备份"](../Chapter_24/24.02.00_MySQL_Enterprise_Backup.md)。
* 备份和重建粒度的范围从整个数据文件到独立的文件。它是否提供表级别的粒度，依赖于存储引擎。例如，InnoDB表能够独立在不同的文件中或者与其它InnoDB表共享文件存储；每个MyISAM表对应唯一的文件集合。
* 除了数据库以外，备份还包括了任何相关文件，例如日志或者配置文件。
* 因为MEMORY表中的内容并不存储在磁盘中，所以很难使用这种方式备份（MySQL企业备份产品有个特性使得你可以在备份的时候从MEMORY表中取得数据。）
* 备份只有在那些具有相同或者相似硬件特性的机器上才能移植。
* 备份在MySQL服务器不运行的时候执行。如果服务器正在运行，需要执行适当锁机制才能保证备份的时候不会改变数据库内容。MySQL企业备份则会在需要的时候自动锁表。
* 物理备份工具为InnoDB或者其它表提供了Mysql企业备份mysqlbackup，文件系统级别的命令（例如cp,scp,tar,rsync）或者为MyISAM表提供mysqlhotcopy。
* 对于还原：
    
    * MySQL企业备份可以重建那些已经备份InnoDB和其它表。
    * ndb_restore可以重建NDB表。
    * 文件系统级别的文件拷贝或者使用mysqlhotcopy命令能够使用文件系统命令复制回它们原始的位置。

逻辑备份方式有三个特性：

* 此备份是通过查询MySQL服务器来保证数据库结构和内容。
* 此备份慢于物理备份方式是因为服务端必须获得数据库信息然后转化成逻辑形式。如果输出结果写在客户端这边，服务端同样必须将数据发送到备份程序。
* 输出结果容量大于物理备份方式，特别是当用文本形式保存。
* 备份和重建粒度可以是服务器级别（所有数据库），数据库级别（特定数据库中的所有表）或者表级别。无论什么存储引擎这都是正确的。
* 此备份不包括日志或者配置文件，或者其它不属于数据库部分的相关文件。
* 此备份存储在独立于机器且高可移植性的逻辑形式中。
* 逻辑备份在MySQL服务运行的时候完成。服务器不需要停机。
* 逻辑备份工具包括了mysqldump程序和SELECT ... INTO OUTFILE语句。这对任何存储引擎都通用，甚至是MEMORY存储引擎。
* 为了重建逻辑备份，SQL形式的dump文件能够使用mysql客户端来处理。为了加载分隔文本的文件，需要使用LOAD DATA INFILE局域或者使用mysqlimport客户端。

### **在线与离线备份**

在线备份发生在MySQL服务器运行的时候因此数据库信息能从服务器上获取。离线备份发生在服务器停止的时候。此区别同样能被描述为热备份和冷备份；温备份则是发生在服务器仍在运行但是锁住防止修改数据而从外部访问数据库文件。
在线备份方式有这些特性：

* 通过连接至MySQL服务器的备份不容易被入侵，它通过执行需要的操作来获得数据。
* 注意加上合适的锁用来保证备份数据完整性时数据不被修改。MySQL企业备份产品会自动加锁。

离线备份方式有这些特性：

* 因为服务器在备份的时候无法使用，所以客户端会受到不利的影响。考虑到这个因素，此类备份经常复制于能够离线而不会影响到可用性的从服务器。
* 此备份过程更简单，因为它不可能受到客户端活动的干扰。

在线和离线申请恢复操作时有一个相似的区别，相似的特征同样适用。但是，相比较在线备份，客户端在线恢复时更容易受到影响，因为恢复需要更重量级锁。在备份过程中，客户端能够读取数据当被备份完成后。恢复过程需要修改数据而非仅仅读取数据，所以客户端需要阻止修改那些需要被重建的数据。

### **本地与远程备份**

本地备份在相同主机上MySQL服务器运行的时候所执行，然而远程备份则是在不同的主机上完成。对于某些类型的备份，备份能在远端主机上被初始化，即使输出结果写在本地服务器上。

* mysqldump能够连接本地或者远端服务器。对于SQL输出（CREATE和INSERT语句），本地或者远端备份能够完成，然后在客户端生成结果。对于分隔本文的输出（使用--tab参数），数据文件是在服务器上被创建。
* mysqlhotcopy只能实现本地备份：它连接到服务器，为了防止数据修改而锁住它，然后备份本地表文件。
* SELECT ... INTO OUTFILE能被本地或者远程客户端主机初始化，但是输出文件则是在服务器上被创建。
* 物理备份方式在本地MySQL服务器主机上典型地被初始化，因此服务器需要脱机，尽管拷贝文件的目的地可能是在远端。

### **快照备份**
一些文件系统实现使得“快照”得以实施。那些文件系统能够在给定的时间点提供本地文件系统的拷贝而不需要整个文件系统物理拷贝。（例如，它的实现可能采用写时复制技术，因此在需要拷贝的快照时间后只有部分文件系统被修改）MySQL自身并不能提供文件系统快照功能。这只能通过第三方解决方式例如Veritas，LVM或者ZFS。

### **全备份和增量备份**

全备份包括了给定时间点内MySQL服务器上所有的数据。增量备份是由给定时间跨度（从一个时间点到另一个时间点）内数据的变化所组成。MySQL有不同方式实施全备份，例如本节先前所描述的那些。增量备份是通过服务器的二进制日志来实现，日志是服务器用来记录数据变更的。

### **全备份和基于时间点（增量）备份**

全部还原从完整备份中重建所有的数据。此操作使得服务器实例恢复到备份时的状态。如果这种状态并非实时，应恢复自从全备份以来的增量备份，使得服务器到最新状态。
增量备份是给定时间跨度内数据变化的备份。它同样被称为时间点备份，因为它使得服务器的状态到给定的时间。时间点的恢复是基于二进制日志，是从备份文件执行全恢复之后重建服务器到备份时的状态。然后记录在二进制日志文件中的变化数据则作为增量备份重做数据修改，将服务器恢复截止到期望的时间点。

### **表维护**

如果表损坏的话，数据完整性将受到破坏。对于InnoDB表，这不是典型的问题。对于程序检查MyISAM表，如果发现存在问题则修复它们，详见[7.6节，MyISAM表维护和崩溃恢复](./07.06.00_MyISAM_Table_Maintenance_and_Crash_Recovery.md)。

对于自动备份程序来说，备份调度是有价值的。压缩备份的输出降低了空间的要求，同时加密的输出提供了更好的安全性，防止未经授权的访问备份数据。MySQL自身并不能提供这些功能。MySQL企业备份产品能够压缩InnoDB备份，使用文件系统工具，可以实现压缩或者加密备份输出。其它第三方解决方案可能实现。