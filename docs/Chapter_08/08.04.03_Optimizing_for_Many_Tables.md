#  8.4.3.为多表优化

### 8.4.3.为多表优化

一些为保持不同的查询快速的技术涉及到将数据分开到很多表。当表的数量达到数千甚至数百万，处理所有这些表的开支变成一个新的性能考虑。

#### 8.4.3.1 MySQL怎样打开和关闭表

当运行mysqladmin status时，将看见象这样的一些东西：

```sql
	Uptime: 426 Running threads: 1 Questions: 11082
	Reloads: 1 Open tables: 12
```

当你只有6个表的时候，**Open tables**的值是12会让你感到懵逼。

MySQL是多线程的，因此许多客户可以同时在同一个表上进行查询。为了使多个客户会话在同一个表上有不同状态的问题减到最小，表被每个并发会话独立地打开。这样需要额外的内存但一般会提高性能。对于**MyISAM**表，数据文件需要为每个打开表的客户提供一个额外的文件描述符。(索引文件描述符在所有会话之间共享)。

[table_open_cache](TODO)和[max_connections](TODO)系统变量影响服务器保持打开的文件的最大数量。如果你增加这些值其中的一个或两个，会遇到操作系统为每个进程打开文件描述符的数量强加的限制。许多操作系统允许你增加打开的文件的限制，尽管该方法随系统的不同而不同。查阅操作系统文档以确定是否可以增加限制以及如何操作。

[table_open_cache](TODO)与[max_connections](TODO)有关。例如，对于200个并行运行的连接，应该让表的缓存至少有**200 * N**，这里**N**是可以执行的查询的一个联接中表的最大数量。还需要为临时表和文件保留一些额外的文件描述符。

你需要考虑到，**MyISAM**存储引擎打开每个表，需要两个文件描述符。对一个拆分后的**MyISAM**表来说，每个分区都需要两个文件描述符来打开。（需要注意的是，当**MyISAM**打开一个分区表之后，无论是否会用到，该表的每个分区都会被打开。参见[MyISAM and partition file descriptor usage](TODO)。）你可以通过增加MySQL的[mysqld](TODO)启动参数`--open-files-limit`来增加可用文件描述符。参看[Section B.5.2.18, “File Not Found and Similar Errors”](TODO)。

打开表的缓存限制由`table_open_cache`限制。数据库在启动的时候会自动设置该参数。你可以把`table_open_cache `作为系统变量在MySQL启动的时候设置。需要注意的是，MySQL为了处理查询而打开的临时表，可能要大于这个值。

在下面的条件下，未使用的表将被关闭并从表缓存中移出：

* 当缓存满了并且一个线程试图打开一个不在缓存中的表时。

* 当缓存包含超过[table_open_cache](TODO)个条目，并且缓存中的表不再被任何线程使用。

* 当表刷新操作发生。当执行**FLUSH TABLES**语句或执行**mysqladmin flush-tables**或**mysqladmin refresh**命令时会发生。

当表缓存满时，服务器使用下列过程找到一个缓存入口来使用：

* 按照最长时间未使用的策略，释放当前未被使用的表

* 当有表需要打开，但是缓存满了，并且没有表可以被释放，则缓存会临时扩大。当缓存处于临时扩大的状态，并且有表由使用中变为未使用，这个表会被从缓存释放。

对于**MyISAM**表的每个访问，都会打开一个表。这意味着，如果2个线程访问同一个表或在同一个查询中访问表两次(例如，将表连接为自身时)，表需要被打开两次。每个并行的打开要求在表缓存中有一个条目。任何表的第一次打开占2个文件描述符：一个用于数据文件另一个用于索引文件。表的每一次额外使用仅占一个数据文件的文件描述符。索引文件描述符在所有线程之间共享。

如果你正用**HANDLER tbl_name OPEN**语句打开一个表，将为该线程专门分配一个表。该表不被其它线程共享，只有线程调用**HANDLER tbl_name CLOSE**或线程终止后才被关闭。表关闭后，被拉回表缓存中(如果缓存不满)。参见[Section 13.2.4, “HANDLER Syntax”.](TODO)。

可以通过检查[mysqld](TODO)的状态变量[Opened_tables](TODO)确定表缓存是否太小，这个变量表明从服务器启动起表打开操作的数目：

```sql
	mysql> SHOW STATUS LIKE 'Opened_tables';
	+---------------+-------+
	| Variable_name | Value |
	+---------------+-------+
	| Opened_tables | 2741  |
	+---------------+-------+
```

如果值很大或增长很快，即使你没有发出许多[FLUSH TABLES](TODO)语句，也应增加表缓存的大小。参见[ection 5.1.5, “Server System Variables”](TODO)和[Section 5.1.7, “Server Status Variables”](TODO)。

#### 8.4.3.2 在同一个数据库创建多张表的劣势

如果在同一个数据库目录中有许多**MyISAM**表，打开、关闭和创建操作将会很慢。如果对许多不同的表执行[SELECT](TODO)语句，当表缓存满时，会有一个持续性的额外开销，因为对每个必须打开的表，另外一个必须被关闭。你可以通过增加在表缓存允许条目的数量来减低开支。