#  8.3.7.InnoDB和MyISAM索引统计集合

### 8.3.7.InnoDB和MyISAM索引统计集合

存储引擎搜集优化器使用的表的统计信息。表统计基于数数值组，其中数数值组是一系列有相同的关键字前缀值的记录。对于优化器，重要的统计即为数数值组的平均大小。

MySQL用下述方式使用平均数数值组：

* 估计必须为每个**ref**访问读取多少行

* 估计部分联接将产生多少行；也就是说，下述形式的操作将产生的行数：

```sql
	(...) JOIN tbl_name ON tbl_name.key = expr
```

随着索引的平均数数值组大小的增加，索引将更没有用，因为每个查找的平均行数增加：为了让索引有利于优化目的，最好是每个索引值对应表内的少量行数。当某个给定的索引值产生较多行时，索引更加没有用，MySQL更不可能使用它。

平均数数值组大小与表的集的势相关，即数数值组的数目。**SHOW INDEX**语句显示集的势值（基于**N/S**），其中**N**是表内的记录数，**S**是平均数数值组大小。该比例产生表内数数值组的大约数。

对于基于**<=>**比较 操作符的联接，**NULL**并不视为与任何其它值不同：**NULL <=> NULL**，正如对于其它**N** ，**N <=> N**。

然而，对于基于**=**操作符的联接，**NULL**与**非NULL**值不同：当**expr1**或**expr2**(或两者)为**NULL**时，**expr1 = expr2**不为真。这样影响比较形式**tbl_name.key = expr**的**ref**访问：如果**expr**当前的值为**NULL**，MySQL不会访问表，因为比较不能为真。

对于**=**比较，表内有多少**NULL**值并不重要。为了优化目的，相关值为**非NULL**数值组的平均大小。然而，MySQL目前不允许搜集或使用该平均大小。

对于**InnoDB**和**MyISAM**表，你可以使用**innodb_stats_method**和**myisam_stats_method**系统变量部分控制表统计信息的搜集。该变量有两个可能的不同值，如下所示：

* 当变量设置为**nulls_equal**，所有**NULL**值被视为相等的(也就是说，它们都形成一个数值组)。
	
	如果NULL数值组大小远大于平均非NULL数值组大小，该方法向上倾斜平均数数值组大小。这样使索引对于优化器来说比它实际为查找非NULL值的联接更加没有用。结果是，nulls_equal方法会使优化器进行ref访问时本应使用索引而没有使用。

* 当变量设置为**nulls_unequal**，**NULL**值不视为相同。相反，每个**NULL**值形成一个单独的数值组，大小为1。

	如果你有许多**NULL**值，该方法向下倾斜平均数数值组大小。如果平均**非NULL**数值组较大，统计大小为1的每个组的NULL值会使优化器过高估计查找非NULL值的联接的索引值。结果是，当其它方法会更好时，**nulls_unequal**方法会使优化器为**ref**查找使用该索引。
	
* 当变量设置为**nulls_ignored**，**NULL**值将被忽略。

	如果你试图使用很多使用**<=>**而不是**=**的查询，**NULL**值在比较里不是特别的，一个**NULL**和另一个相等。在这种情况，**null_equal**是适当的统计方法。
	
	**innodb_stats_method**系统变量有一个全局值；**myisam_stats_method**系统变量既有全局值，也有会话值。设置全局值影响相应存储引擎的表的统计集合。设置会话值只有影响当前客户端连接的统计集合。这就意味着你可以通过设置**myisam_stats_method**的会话值以一个指定的方法强制令一张表的统计重新生成，而不会影响其他表。
	
	要重新生成表的统计，你可以使用以下方法的一种：
	
	* 执行 **myisamchk --stats_method=method_name --analyze**
	
	* 改变表以引起它的统计过时（例如，插入一行然后删除），然后设置**myisam_stats_method**和执行**ANALYZE TABLE**语句。
	
	关于使用**innodb_stats_method**和**myisam_stats_method**的一些警告：

	* 你可以强制显式搜集表的统计信息，如上所述。然而，MySQL也可以自动搜集统计信息。例如，如果在为表执行语句的过程中，一些语句修改了表，MySQL可以搜集统计信息。(例如，大批插入或删除，或者执行**ALTER TABLE**语句时可能发生）。如果发生，使用**innodb_stats_method**和**myisam_stats_method**此时所有的值搜集统计信息。这样，如果你使用一个方法搜集统计信息，但当后面自动搜集一个表的统计信息时系统变量被设置为另一个方法，将使用其它方法。

	* 对于给定的表，还不能说出使用哪个方法来产生统计信息。

	* 这些系统变量只适合**InnoDB**和**MyISAM**表。其它存储引擎只有一个方法来搜集表的统计信息。通常它接近于**nulls_equal**方法。


