# 19.6. 存储程序和视图的访问控制

## 19.6. 存储程序和视图的访问控制

存储程序和视图, 都是先定义后使用. 当被引用时, 其执行时权限由当时的安全认证环境所决定. 这些权限由定义者(`DEFINER`)的属性, 和可能存在的SQL SECURITY特性共同控制. 

所有的存储程序(存储过程, 函数, 触发器和事件), 以及视图都可拥有以MySQL账户命名的定义者(`DEFINER`)属性. 如果存储程序或者视图的定义中省略了该属性, 默认的账户是创建该对象的账户. 

此外, 存储例程(存储过程和函数)以及视图还可拥有SQL SECURITY特性. 该特性的取值包括`DEFINER`和`INVOKER`. 由该特性的取证决定对象的运行究竟是基于定义者环境, 或调用者环境运行. 

如果SQL SECURITY特性被省略了, 默认为定义者环境. 触发器和事件没有SQL SECURITY特性, 全部基于定义者环境执行. 服务端按照需要自动激活并调用这些对象, 不存在主调用户. 

定义者环境和调用者环境有如下的区别: 
* 在定义者环境下, 存储程序或试图的执行权限由`DEFINER`属性对应账户的权限来确定. 这些权限可能与激活调用该对象的用户完全不同. 调用者首先必须拥有适当的权限, 以引用该对象(比如说, `EXECUTE [774]`权限用来调用存储过程, `SELECT [775]`权限用来查询视图).但当对象启动之后, 调用者的权限将被忽略, 按照DEFINER账户的权限决定结果. 如果该账户只有很少量的权限, 则该对象所能完成的操作将非常有限. 反之, 如果`DEFINER`账户有很高的权限, 则该对象将能够完成强大的操作功能, 不管是谁发起的调用. 

* 在调用者环境下, 存储程序或试图的执行权限只能根据调用者所拥有的权限完成操作. 尽管`DEFINER`属性已被声明, 但是在调用者环境下其等于是无效的, 对对象的执行没有任何影响. 

考虑如下的存储过程: 

	CREATE DEFINER = 'admin'@'localhost' PROCEDURE p1()
	SQL SECURITY DEFINER
	BEGIN
	  UPDATE t1 SET counter = counter + 1;
	END;

对于`p1`, 任何拥有`EXECUTE [774]`权限的用户, 都可以借用`CALL`语句来调用它. 但是, 在执行时, `p1`将基于`DEFINER`安全环境下, 因此执行时的权限和`'admin'@'localhost'`是一样的, 该账户存在于`p1`的`DEFINER`属性. 该账户必须同时拥有`EXECUTE [774]`权限和`UPDATE [776]`权限. 否则, 该存储过程的调用失败. 

现在考虑`p2`如下, 该存储过程其除了SQL SECURITY特性为`INVOKER`之外, 与`p1`完全一致: 

	CREATE DEFINER = 'admin'@'localhost' PROCEDURE p2()
	SQL SECURITY INVOKER
	BEGIN
	  UPDATE t1 SET counter = counter + 1;
	END;

但是与`p1`不同, 其执行于`INVOKER`安全环境下. `DEFINER`属性对`p2`毫无影响. `p2`执行于调用者的权限之内. 如果调用者没有`EXECUTE [774]`权限或者对于表t1的`UPDATE [776]`权限, 任缺其一`p2`都会失败. 

对于用户账户关于对象`DEFINER`属性的声明, MySQL使用如下的规则进行控制: 

* 仅拥有`SUPER [776]`权限的用户可以将`DEFINER`的值声明为其它账户. 
* 如果没有`SUPER [776]`权限, 唯一合法的用户值为本账户值. 不管是使用明文字符, 或是使用`CURRENT_USER [1288]`替代. 不可将定义者设定为其它账户. 

为了减少存储程序或视图创建和使用中的潜在风险, 建议遵从如下说明: 

* 对于存储例程或视图, 如果可行的话在对象定义时尽量采用`SQL SECURITY INVOKER`, 这样的好处在于使得对象能够实现的操作恰好与用户拥有的权限相匹配,易于管理并降低风险. 
* 在创建包含定义者环境的存储程序或视图时, 所使用的账户拥有`SUPER [776]`权限, 请将`DEFINER`属性显式地声明为一个账户. 该账户仅拥有通过该对象完成的相应操作所必需的权限. 仅当明确需要时, 才将其声明为一个高等级权限的`DEFINER`账户. 
* 管理员可以通过不对用户授予	`SUPER [776]`权限的方式, 以避免用户声明高级别的`DEFINER`账户属性. 
* 包含定义者环境的对象有可能使让无权限的调用者访问到其无权访问的数据, 这一点应牢记于心. 

在有些场景下, 可以通过不授予非认证用户一些特殊的权限以阻止其对这些对象的引用: 

* 如果用户没有`EXECUTE [774]`权限, 则该用户无法引用存储过程或函数. 
* 如果用户没有适当的权限, 将无法引用视图(`SELECT [775]`权限以查询视图, `INSERT [775]`以插入, 等等). 

但是, 由于用户不直接引用触发器, 对于触发器不存在相应的控制. 触发器总基于`DEFINER`环境执行, 它通过由对于该触发器相关联的表的访问操作激活, 即使是无特殊权限用户的普通的表访问. 如果触发器的定义者拥有高等级权限, 则有可能使触发器执行一些敏感甚至危险的操作. 即使当创建触发器所需的`SUPER [776]`和`TRIGGER [776]`权限已经从创建者的账户中移除, 这一点同样会发生. 管理员对于将这种组合权限授予用户, 应当特别注意. 
