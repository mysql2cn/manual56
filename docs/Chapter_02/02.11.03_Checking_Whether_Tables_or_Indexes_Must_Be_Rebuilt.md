# 2.11.3. 检查是否需要重建表或索引

### 2.11.3. 检查是否需要重建表或索引

二进制升级或降级是指在一个已存在的版本上“就地”安装另外一个版本MySQL，而不需要转储和重新载入表：

1. 当前版本的服务器如果在运行，将其关闭。

2. 安装不同版本的MySQL。如果新安装版本的MySQL高于原来版本，则是升级；而如果低于原来版本则是降级。

3. 使用新安装版本启动服务器。

多数情况下，新版本的MySQL使用之前版本中的表都不会有问题。但是，如本节所描述的，有些改变可能会导致需要修复表或表索引。如果有被这里描述的问题影响到的表，参见[2.11.4节，“重建或修复表或索引”](./02.11.04_Rebuilding_or_Repairing_Tables_or_Indexes.md)中的说明来在必要时重建表或索引。

**表不兼容**

将含有 **ARCHIVE** 表的MySQL 5.0安装使用二进制升级到MySQL 5.1后，访问这些表可能会导致服务器崩溃，即便执行了 **mysql_upgrade** 或 **CHECK TABLE ... FOR UPGRADE**。要解决这个问题，在升级之前使用 **mysqldump** 转储所有的 **ARCHIVE** 表，然后在升级后载入到MySQL 5.1中。同样的问题也会在由MySQL 5.1降级到5.0时产生。

这个升级问题在MySQL 5.6.4中解决：服务器可以打开在MySQL 5.0中创建的 **ARCHIVE** 表。但是，依然推荐在升级前转储5.0中的 **ARCHIVE**表并在升级后重新载入。

**索引不兼容**

从MySQL 5.6.3开始，对于使用 **ROW_FORMAT=DYNAMIC** 或 **ROW_FORMAT=COMPRESSED** 的 **InnoDB** 表， 索引前缀的长度限制由767字节增加到了3072字节。详细信息参见[14.2.7节，“InnoDB表的限制”](../Chapter_14/14.02.07_Limits_on_InnoDB_Tables.md)。这个更改也被移植到了MySQL 5.5.14中。如果由这些版本或更高版本降级到长度限制较小的更早版本，索引前缀会被截短到767字节，或者降级可能失败。这个问题只会在要降级的服务器使用 **innodb_large_prefix** 时产生。

使用二进制升级而不进行转储和重载表无法由MySQL 4.1直接升级到5.1或更高版本。这是因为MySQL 5.0中对于 **MyISAM** 表索引的一个不兼容更改。先由MySQL 4.1升级到5.0并修复所有的 **MyISAM** 表。然后将MySQL 5.0升级到5.1并检查和修复表。

对字符集或比较规则处理的更改可能会改变字符的排序，进而导致使用受影响字符集或比较规则的索引中不正确的排序。这样的更改会引起一些可能的问题：

* 比较结果与之前的结果不同。

* 因为乱序索引而无法找到某些索引值。

* 乱序的 **ORDER BY** 结果。

* **CHECK TABLE** 报告需要修复的表。

这些问题的解决方案是重建使用受影响的字符集或比较规则的索引，要么删除并重新创建索引，要么转储并重载整个表。在某些情况下，将受影响的列改为使用其他的比较规则也是可能的。关于重建索引的信息，参见[2.11.4节，“重建或修复表或索引”](./02.11.04_Rebuilding_or_Repairing_Tables_or_Indexes.md)。

要检查某个表是否含有需要重建的索引，参考下面的列表。这个列表列出了哪些版本的MySQL引入了需要重建索引的字符集或比较规则改变。每个条目都指出了产生更改并且字符集或比较规则收到更改影响的版本。如果更改与一个特定的bug报告相关，bug号也同样被列出。

这个列表适用于二进制升级和降级。例如，Bug #27877在MySQL 5.1.24中解决，因此它适用于由比5.1.24旧的版本升级到5.1.24或更新版本，以及由5.1.24或更新版本降级到比5.1.24旧的版本。

有些情况下，可以使用 **CHECK TABLE ... FOR UPGRADE**来鉴定需要重建索引的表。它会报告这样的信息：

```
Table upgrade required.
Please do "REPAIR TABLE `tbl_name`" or dump/reload to fix it!
```

这些情况下也可以使用 **mysqlcheck --check-upgrade** 或 **mysql_upgrade**，他们会执行 **CHECK TABLE**。但是，**CHECK TABLE** 仅适用于升级，而不适用于降级。而且，**CHECK TABLE** 并不适用于所有的存储引擎。关于 **CHECK TABLES** 支持哪些存储引擎，参见[13.7.2.2节，“CHECK TALBE 语法”](../Chapter_13/13.07.02_Table_Maintenance_Statements.md#13.07.02.02)。

这些更改会导致必须重建索引：

* MySQL 5.1.24 （Bug #27877）

    影响含有 **'ß'** LATIN SMALL LETTER SHARP S (German)并使用 **utf8_general_ci** 或 **ucs2_genearl_ci** 比较规则的列的索引。这个bug修复纠正了原有比较规则中的错误，但是引入的不兼容性导致 **'ß'** 与之前比较不同的字符现在比较起来相同。

    从MySQL 5.1.30开始（参见Bug #40053）受影响的表可以通过 **CHECK TABLE ... FOR UPGRADE** 检测。

    




